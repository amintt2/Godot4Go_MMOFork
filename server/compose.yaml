services:
  gameserver:
    build:
      context: .
      dockerfile: Dockerfile
    # env_file:
    #   - .env
    environment:
      - PORT=${PORT:-8080} # Define PORT, configurable in Coolify UI, default 8080
      - DATA_PATH=${DATA_PATH:-./data} # Define DATA_PATH, configurable in Coolify UI, default ./data
      # - SERVICE_FQDN_GAMESERVER_8080 # Use labels instead
    volumes:
      - ${DATA_PATH}:/gameserver/data
    labels: # Explicit Traefik configuration
      - traefik.enable=true
      - traefik.http.routers.gameserver-proxy.rule=Host(`hcosw804gkcwcg408cks4k0g.mciut.fr`)
      - traefik.http.routers.gameserver-proxy.entrypoints=https
      - traefik.http.routers.gameserver-proxy.tls=true
      - traefik.http.routers.gameserver-proxy.tls.certresolver=letsencrypt # Assuming default cert resolver name
      - traefik.http.routers.gameserver-proxy.service=gameserver-svc
      - traefik.http.services.gameserver-svc.loadbalancer.server.port=8080 # Internal container port
    # ports:
    #  - "${PORT}:${PORT}"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:${PORT:-8080}/"] # Check if the server responds on the root path
      interval: 30s # Check every 30 seconds
      timeout: 10s # Wait 10 seconds for response
      retries: 3 # Try 3 times before marking as unhealthy
      start_period: 60s # Wait 60 seconds after start before first check
    networks: # Explicitly connect to the coolify network for the proxy
      - coolify

# Define the coolify network as external (created by Coolify)
networks:
  coolify:
    external: true